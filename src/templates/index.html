<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="./css/index.css">
</head>

<body style="background: transparent;">
    <div class="container-fluid bg-light" style="border-radius: 5%;">
        <div class="row">       
            <div class="col-3" style="height: 100vh; background: #8DA1AF">	
                <div class="list-group">
					<button id="device" class="list-group-item btn btn-outline-dark mt-5"><span class="fa fa-desktop"></span> Device</button>
                    <button id="download" class="list-group-item btn btn-outline-dark mt-2"><span class="fa fa-download"></span> Download</button>
                    <button id="map" class="list-group-item btn btn-outline-dark mt-2"><span class="fa fa-map-marker"></span> Map Tracker</button>
                    <button id="settings" class="list-group-item btn btn-outline-dark mt-2"><span class="fa fa-cogs"></span> Settings</button>
					<button id="setup" class="list-group-item btn btn-outline-dark mt-2"><span class="fa fa-cog"></span> Device Setup</button>
					<button id="devtools" class="list-group-item btn btn-outline-dark mt-2"><span class="fa fa-code"></span> Dev Tools</button>
                </div>
            </div>

			<div class="col-9 mt-3 pt-2">

				<div class="row" id="div_comm_type">
					<div class="col-4">
						Connection Type
					</div>
					<div class="col-4">
						<select id="comm_type" class="form-control" onchange="connChange()">
							<option value="0"> --- None --- </option>
							<option value="1">WiFi</option>
							<option value="2">Serial Port</option>
						</select>
					</div>
				</div>

				<div class="row pt-1" id="Connect">

				</div>

				<div class="dropdown-divider mt-1 mb-1"></div>
				<div class="row">
					<div class="col-8">
						<div class="row">
							<div class="col-6">
								<small id="dateHelpBlock" class="form-text text-muted">Date</small>
								<div class="input-group mb-2">
									<div class="input-group-prepend">
									  <div class="input-group-text"><span class="fa fa-calendar"></span></div>
									</div>
									<input type="text" class="form-control" id="date" placeholder="Date" aria-describedby="dateHelpBlock" disabled>
								  </div>
							</div>
							<div class="col-6">
								<small id="timeHelpBlock" class="form-text text-muted">Time</small>
								<div class="input-group mb-2">
									<div class="input-group-prepend">
									  <div class="input-group-text"><span class="fa fa-clock-o"></span></div>
									</div>
									<input type="text" class="form-control" id="time" placeholder="Time" aria-describedby="timeHelpBlock" disabled>
								  </div>
							</div>
						</div>
						<div class="row mt-2">
							<div class="col-6">
								<small id="latitudeHelpBlock" class="form-text text-muted">Latitude</small>
								<div class="input-group mb-2">
									<div class="input-group-prepend">
									  <div class="input-group-text"><span class="fa fa-arrow-up"></span></div>
									</div>
									<input type="text" class="form-control" id="latitude" placeholder="Latitude" aria-describedby="latitudeHelpBlock" disabled>
								  </div>
							</div>
							<div class="col-6">
								<small id="longitudeHelpBlock" class="form-text text-muted">Longitude</small>
								<div class="input-group mb-2">
									<div class="input-group-prepend">
									  <div class="input-group-text"><span class="fa fa-arrow-right"></span></div>
									</div>
									<input type="text" class="form-control" id="longitude" placeholder="Longitude" aria-describedby="longitudeHelpBlock" disabled>
								  </div>
							</div>
						</div>
						<div class="row mt-2">
							<div class="col-6">
								<small id="hdopHelpBlock" class="form-text text-muted">HDOP</small>
								<div class="input-group mb-2">
									<div class="input-group-prepend">
									  <div class="input-group-text"><small>*</small></div>
									</div>
									<input type="text" class="form-control" id="hdop" placeholder="HDOP" aria-describedby="hdopHelpBlock" disabled>
								  </div>
							</div>
							<div class="col-6">
								<small id="speedHelpBlock" class="form-text text-muted">Speed</small>
								<div class="input-group mb-2">
									<div class="input-group-prepend">
									  <div class="input-group-text"><span class="fa fa-spinner"></span></div>
									</div>
									<input type="text" class="form-control" id="speed" placeholder="Speed" aria-describedby="speedHelpBlock" disabled>
								  </div>
							</div>
						</div>
					</div>
					<div class="col-4">
						<div class="row">
							<div class="col-4">
								<span class="fa fa-laptop fa-4x"></span>
							</div>
							<div class="col-12">
								<small class="text-muted">RTK</small>
								<p class="text-muted">Rover SN: 12345</p>
							</div>
						</div>
						<div class="row">
							
						</div>
					</div>
				</div>

				<div class="row mt-2">
					<div class="col-4">
						<small id="rtkStatusHelpBlock" class="form-text text-muted">RTK Status</small>
						<div class="input-group mb-2">
							<div class="input-group-prepend">
							  <div class="input-group-text">@</div>
							</div>
							<input type="text" class="form-control" id="rtkStatus" placeholder="RTK Status" aria-describedby="rtkStatusHelpBlock" disabled>
						  </div>
					</div>
					<div class="col-4">
						<small id="rtkAgeHelpBlock" class="form-text text-muted">RTK Age</small>
						<div class="input-group mb-2">
							<div class="input-group-prepend">
							  <div class="input-group-text">#</div>
							</div>
							<input type="text" class="form-control" id="rtkAge" placeholder="RTK Age" aria-describedby="rtkAgeHelpBlock" disabled>
						  </div>
					</div>
					<div class="col-4">
						<small id="rtkRatioHelpBlock" class="form-text text-muted">RTK Ratio</small>
						<div class="input-group mb-2">
							<div class="input-group-prepend">
							  <div class="input-group-text">:</div>
							</div>
							<input type="text" class="form-control" id="rtkRatio" placeholder="RTK Ratio" aria-describedby="rtkRatioHelpBlock" disabled>
						  </div>
					</div>
				</div>
				
				<div class="dropdown-divider mt-3 mb-3"></div>

				<div class="row">
					<div class="col">
						<h5>Live Data Feed</h5>
						<div class="list-group" id="feeds" style="height: 180px; overflow-y: scroll;">
							<ul>
								<!-- Connect to Serial Port to view Live Feeds... -->
							</ul>
						</div>
					</div>
				</div>
			</div>
        </div>
    </div>

	<script>
		const { ipcRenderer } = require('electron');

		window.onload = (event) => {
			console.log('page is fully loaded');
			var hotspot_credentials = {ssid:'$EZ_RTK',password:'1234567890'};
			ipcRenderer.send('read:credentials', hotspot_credentials);
		};

		//Menu selectors
		document.querySelector('#device').addEventListener('click', (event) => {
			ipcRenderer.send('open:device');
		});
		document.querySelector('#download').addEventListener('click', (event) => {
			ipcRenderer.send('open:download');
		});
		document.querySelector('#map').addEventListener('click', (event) => {
			ipcRenderer.send('open:map');
		});
		document.querySelector('#settings').addEventListener('click', (event) => {
			ipcRenderer.send('open:settings');
		});

		document.querySelector('#devtools').addEventListener('click', (event) => {
			ipcRenderer.send('open:devtools');
		});

		//Device setup
		document.querySelector('#setup').addEventListener('click', (event) => {
			ipcRenderer.send('device:setup');
		});

		const ul = document.querySelector('ul');

		// receiving and parsing nmea file
		ipcRenderer.on('parse:nmea', (event, sentence) => {
			var split_list = sentence.split('\n');

			// for(var i=0;i<split_list.length;i++){
			// 	const li = document.createElement('li');
			// 	const text = document.createTextNode(split_list[i]);
			// 	li.appendChild(text);
			// 	ul.appendChild(li);
			// }

            const li = document.createElement('li');
            const text = document.createTextNode(sentence);
            li.appendChild(text);
			ul.appendChild(li);

			document.getElementById('feeds').scrollIntoView();

			var nmea = sentence.split(",");
			var time = nmea[1].substring(0,2) + ":" + nmea[1].substring(2,4) + ":" + nmea[1].substring(4,6);
			var date = nmea[9].substring(0,2) + "/" + nmea[9].substring(2,4) + "/" + nmea[9].substring(4,6);
			var speed = nmea[7] + " knots";
		    

		    var latDeg = parseInt(nmea[3].substring(0, 2));
		    var latMin = nmea[3].substring(2);
		    var lat = latDeg + (latMin/60);
		    var latDirection = nmea[4];

		    var lngDeg = parseInt(nmea[5].substring(0, 3));
		    var lngMin = nmea[5].substring(3);
		    var lng = lngDeg + (lngMin/60);
		    var lngDirection = nmea[6];

		    document.querySelector('#latitude').value = lat.toString() + latDirection;
			document.querySelector('#longitude').value = lng.toString() + lngDirection;
			document.querySelector('#speed').value = speed;
			document.querySelector('#time').value = time;
			document.querySelector('#date').value = date;
			document.querySelector('#an').innerHTML = sentence;

			
		});
		
		// sending selected port and baudRate
		function connectSerial() {
			var p = document.querySelector('#serial_port').value;
			var baudRate = document.querySelector('#baudRate').value;
			var serial_details = [];

			serial_details.push(p);
			serial_details.push(baudRate);

			if (!p)
				return false;
			ipcRenderer.send('connect_serial', (event, serial_details));
			
			// removing the last selected serial port and baudRate
			serial_details.pop();
			serial_details.pop();
		}

		// sending selected wifi
		function connectWifi() {
			var wifi = document.querySelector('#wifi').value;
			var password = document.querySelector('#password').value;
			console.log(wifi + " " + password);
			var wifi_details = [];

			wifi_details.push(wifi);
			wifi_details.push(password);
			if (!wifi_details) 
				return false;
			ipcRenderer.send('connect_wifi', (event, wifi_details));

			wifi_details.pop();
			wifi_details.pop();
		}

		ipcRenderer.on('load:device', (event, ports) => {
			let port_menu = document.querySelector('#serial_port');
			port_menu.innerHTML = "";
			for (var i=0;i<ports.length;i++) {
				const op = document.createElement('option');
				op.innerHTML = ports[i];
				op.value = ports[i];
				port_menu.appendChild(op);	
			}
		});

		ipcRenderer.on('load:wifi', (event, wifi) => {
			let wifi_menu = document.querySelector('#wifi');
			wifi_menu.innerHTML = "";
			for (var i=0;i<wifi.length;i++) {
				const op = document.createElement('option');
				op.innerHTML = wifi[i];
				op.value = wifi[i];
				wifi_menu.appendChild(op);	
			}
		});

		var wifi = '<div class="col-4">'+
						'<select id="wifi" class="form-control">' +
							
						'</select>'+
					'</div>'+
					'<div class="col-4">'+
						'<input id="password" type="password" value="bedrock@8540" class="form-control" placeholder="Password">'+
					'</div>'+
					'<div class="col-4">'+
						'<button type="button" onclick="connectWifi()" class="btn btn-outline-secondary">Connect <i class="fa fa-plug"></i></button>'+
					'</div>';

		var serial = '<div class="col-4"><select id="serial_port" class="form-control"></select></div>' +
					'<div class="col-4"><select id="baudRate" class="form-control">'+
						'<option>9600</option><option>115200</option></select>'+
					'</div>'+
					'<div class="col-4"><button type="button" id="connect_serial" onclick="connectSerial()" class="btn btn-outline-secondary">Connect <i class="fa fa-plug"></i></button></div>';

		function connChange() {
			var conType = document.getElementById('comm_type').value;
						
			console.log(conType);
			if (conType == 0) {
				document.getElementById('Connect').innerHTML = "";
				ipcRenderer.send('conn:close');
			}
			else if(conType == 1) {
				document.getElementById('Connect').innerHTML = wifi;
				ipcRenderer.send('load:wifi');
			} else {
				document.getElementById('Connect').innerHTML = serial;
				ipcRenderer.send('load:device');
			}
		}

	</script>

</body>